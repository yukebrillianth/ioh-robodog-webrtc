<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Server ‚Äî Robot Dog Control View</title>
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --border: #2a3a4e;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-amber: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-connected {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-connecting {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-amber);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected .status-dot {
            background: var(--accent-green);
        }

        .status-disconnected .status-dot {
            background: var(--accent-red);
            animation: none;
        }

        .status-connecting .status-dot {
            background: var(--accent-amber);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .main {
            display: flex;
            height: calc(100vh - 44px);
        }

        .video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .video-overlay {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 10;
        }

        .overlay-badge {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .overlay-badge .value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .live-indicator {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            font-weight: 700;
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 3px;
            border: none;
            animation: livePulse 1.5s infinite;
        }

        @keyframes livePulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            overflow-y: auto;
            font-size: 12px;
        }

        .sidebar-section {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section h3 {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            text-align: right;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 12px;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .btn-danger {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .log-container {
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            font-size: 10px;
            padding: 2px 0;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .log-entry.info {
            color: var(--accent-blue);
        }

        .log-entry.warn {
            color: var(--accent-amber);
        }

        .log-entry.error {
            color: var(--accent-red);
        }

        .log-entry.success {
            color: var(--accent-green);
        }

        .no-video {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .no-video svg {
            opacity: 0.3;
        }

        .config-input {
            width: 100%;
            padding: 6px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 11px;
            border-radius: 4px;
            margin-top: 6px;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-title">
            <span>‚óâ</span>
            <span>ROBOT DOG ‚Äî CONTROL VIEW</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
            <div id="statusBadge" class="status-badge status-disconnected">
                <div class="status-dot"></div>
                <span id="statusText">DISCONNECTED</span>
            </div>
            <span style="color:var(--text-secondary);font-size:11px;" id="clockDisplay">--:--:--</span>
        </div>
    </div>

    <div class="main">
        <div class="video-container">
            <video id="videoPlayer" autoplay muted playsinline></video>
            <div class="video-overlay">
                <div class="overlay-badge live-indicator" id="liveTag" style="display:none;">‚óè LIVE</div>
                <div style="display:flex;gap:6px;">
                    <div class="overlay-badge"><span class="stat-label">FPS:</span> <span class="value" id="overlayFps">--</span></div>
                    <div class="overlay-badge"><span class="stat-label">Bitrate:</span> <span class="value" id="overlayBitrate">--</span></div>
                    <div class="overlay-badge"><span class="stat-label">RTT:</span> <span class="value" id="overlayRtt">--</span></div>
                </div>
            </div>
            <div class="no-video" id="noVideoMsg">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="2" y="4" width="15" height="14" rx="2" />
                    <path d="M17 9l5-3v10l-5-3V9z" />
                </svg>
                <span>No video stream ‚Äî click Connect</span>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-section">
                <h3>Connection</h3>
                <div style="margin-bottom:8px;">
                    <label class="stat-label">Server URL</label>
                    <input type="text" class="config-input" id="serverUrl" placeholder="ws://192.168.1.x:8080">
                </div>
                <div style="display:flex;gap:6px;">
                    <button class="btn" id="btnConnect" onclick="connect()">Connect</button>
                    <button class="btn btn-danger" id="btnDisconnect" onclick="disconnect()" style="display:none;">Disconnect</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Stream Statistics</h3>
                <div class="stat-row"><span class="stat-label">State</span><span class="stat-value" id="statState">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">ICE State</span><span class="stat-value" id="statIce">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Codec</span><span class="stat-value" id="statCodec">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Resolution</span><span class="stat-value" id="statRes">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">FPS</span><span class="stat-value" id="statFps">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Bitrate</span><span class="stat-value" id="statBitrate">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">RTT</span><span class="stat-value" id="statRtt">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Packets Lost</span><span class="stat-value" id="statLost">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Jitter</span><span class="stat-value" id="statJitter">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Bytes Received</span><span class="stat-value" id="statBytes">‚Äî</span></div>
            </div>

            <div class="sidebar-section">
                <h3>Connection Info</h3>
                <div class="stat-row"><span class="stat-label">Type</span><span class="stat-value" id="statConnType">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Remote IP</span><span class="stat-value" id="statRemoteIp">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Local IP</span><span class="stat-value" id="statLocalIp">‚Äî</span></div>
                <div class="stat-row"><span class="stat-label">Protocol</span><span class="stat-value" id="statProtocol">‚Äî</span></div>
            </div>

            <div class="sidebar-section">
                <h3>Event Log</h3>
            </div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoPlayer');
        const logContainer = document.getElementById('logContainer');
        let ws = null;
        let pc = null;
        let peerId = null;
        let iceServersFromServer = null; // TURN/STUN config received from server
        let statsInterval = null;
        let prevBytesReceived = 0;
        let prevTimestamp = 0;
        let reconnectTimer = null;

        // Auto-detect server URL
        const defaultWsUrl = `ws://${window.location.hostname || 'localhost'}:8080`;
        document.getElementById('serverUrl').value = defaultWsUrl;

        // Clock
        setInterval(() => {
            document.getElementById('clockDisplay').textContent =
                new Date().toLocaleTimeString('en-US', { hour12: false });
        }, 1000);

        function log(msg, level = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            entry.textContent = `[${new Date().toLocaleTimeString('en-US', { hour12: false })}] ${msg}`;
            logContainer.prepend(entry);
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function setStatus(state) {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');
            badge.className = 'status-badge status-' + state;
            text.textContent = state.toUpperCase();

            const btnConnect = document.getElementById('btnConnect');
            const btnDisconnect = document.getElementById('btnDisconnect');
            const liveTag = document.getElementById('liveTag');
            const noVideo = document.getElementById('noVideoMsg');

            if (state === 'connected') {
                btnConnect.style.display = 'none';
                btnDisconnect.style.display = 'block';
                liveTag.style.display = 'block';
                noVideo.style.display = 'none';
            } else if (state === 'connecting') {
                btnConnect.style.display = 'none';
                btnDisconnect.style.display = 'block';
                liveTag.style.display = 'none';
            } else {
                btnConnect.style.display = 'block';
                btnDisconnect.style.display = 'none';
                liveTag.style.display = 'none';
                noVideo.style.display = 'flex';
            }
        }

        async function connect() {
            const url = document.getElementById('serverUrl').value.trim();
            if (!url) return;

            setStatus('connecting');
            log('Connecting to ' + url + '...', 'info');

            try {
                ws = new WebSocket(url);
            } catch (e) {
                log('WebSocket creation failed: ' + e.message, 'error');
                setStatus('disconnected');
                return;
            }

            ws.onopen = () => {
                log('WebSocket connected', 'success');
            };

            ws.onclose = (e) => {
                log(`WebSocket closed (code: ${e.code})`, 'warn');
                cleanup();
                // Auto-reconnect after 3 seconds
                reconnectTimer = setTimeout(() => {
                    if (!ws || ws.readyState === WebSocket.CLOSED) {
                        log('Auto-reconnecting...', 'info');
                        connect();
                    }
                }, 3000);
            };

            ws.onerror = (e) => {
                log('WebSocket error', 'error');
            };

            ws.onmessage = async (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    await handleSignaling(msg);
                } catch (e) {
                    log('Failed to parse message: ' + e.message, 'error');
                }
            };
        }

        async function handleSignaling(msg) {
            switch (msg.type) {
                case 'welcome':
                    peerId = msg.peerId;
                    iceServersFromServer = msg.iceServers || null;
                    log('Assigned peer: ' + peerId, 'success');
                    if (iceServersFromServer && iceServersFromServer.length > 0) {
                        const hasTurn = iceServersFromServer.some(s => s.urls && s.urls.startsWith('turn:'));
                        log('ICE servers: ' + iceServersFromServer.length + (hasTurn ? ' (with TURN relay)' : ' (STUN only)'), hasTurn ? 'success' : 'warn');
                    }
                    // Initialize PeerConnection, server will send offer next
                    initPeerConnection();
                    log('Waiting for server offer...', 'info');
                    break;

                case 'offer':
                    // Server sends offer (it has the sendonly video track)
                    if (pc) {
                        log('Received SDP offer from server', 'info');
                        const offer = new RTCSessionDescription({ type: 'offer', sdp: msg.sdp });
                        await pc.setRemoteDescription(offer);
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
                            log('Sent SDP answer', 'success');
                        }
                    }
                    break;

                case 'candidate':
                    if (pc && msg.data) {
                        try {
                            await pc.addIceCandidate(new RTCIceCandidate(msg.data));
                        } catch (e) {
                            log('ICE candidate error: ' + e.message, 'warn');
                        }
                    }
                    break;

                case 'error':
                    log('Server error: ' + (msg.message || 'unknown'), 'error');
                    break;

                case 'pong':
                    break;

                default:
                    log('Unknown message: ' + msg.type, 'warn');
            }
        }

        function initPeerConnection() {
            // Use ICE servers from server (includes TURN for NAT traversal)
            const iceServers = iceServersFromServer && iceServersFromServer.length > 0
                ? iceServersFromServer
                : [
                    { urls: 'stun:stun.cloudflare.com:3478' },
                    { urls: 'stun:stun.l.google.com:19302' }
                ];

            const config = {
                iceServers: iceServers,
                bundlePolicy: 'max-bundle',
                rtcpMuxPolicy: 'require'
            };

            pc = new RTCPeerConnection(config);

            pc.ontrack = (event) => {
                log('Received video track', 'success');
                video.srcObject = event.streams[0] || new MediaStream([event.track]);
                video.play().catch(() => { });
            };

            pc.onicecandidate = (event) => {
                if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'candidate',
                        data: {
                            candidate: event.candidate.candidate,
                            sdpMid: event.candidate.sdpMid,
                            sdpMLineIndex: event.candidate.sdpMLineIndex
                        }
                    }));
                }
            };

            pc.onconnectionstatechange = () => {
                const state = pc.connectionState;
                document.getElementById('statState').textContent = state;
                log('Connection: ' + state, state === 'connected' ? 'success' : 'info');

                if (state === 'connected') {
                    setStatus('connected');
                    startStatsMonitor();
                } else if (state === 'failed' || state === 'closed') {
                    setStatus('disconnected');
                    stopStatsMonitor();
                }
            };

            pc.oniceconnectionstatechange = () => {
                document.getElementById('statIce').textContent = pc.iceConnectionState;
            };
        }

        function startStatsMonitor() {
            stopStatsMonitor();
            prevBytesReceived = 0;
            prevTimestamp = 0;

            statsInterval = setInterval(async () => {
                if (!pc) return;

                const stats = await pc.getStats();
                stats.forEach(report => {
                    if (report.type === 'inbound-rtp' && report.kind === 'video') {
                        // FPS
                        const fps = report.framesPerSecond || 0;
                        document.getElementById('statFps').textContent = fps.toFixed(0);
                        document.getElementById('overlayFps').textContent = fps.toFixed(0);

                        // Bitrate
                        const now = report.timestamp;
                        const bytes = report.bytesReceived || 0;
                        if (prevTimestamp > 0) {
                            const dt = (now - prevTimestamp) / 1000;
                            const bitrate = ((bytes - prevBytesReceived) * 8) / dt / 1000;
                            const br = bitrate.toFixed(0);
                            document.getElementById('statBitrate').textContent = br + ' kbps';
                            document.getElementById('overlayBitrate').textContent = br + ' kbps';
                        }
                        prevBytesReceived = bytes;
                        prevTimestamp = now;

                        // Packets lost
                        document.getElementById('statLost').textContent = report.packetsLost || 0;

                        // Jitter
                        const jitter = report.jitter ? (report.jitter * 1000).toFixed(1) + ' ms' : '‚Äî';
                        document.getElementById('statJitter').textContent = jitter;

                        // Bytes
                        const mb = (bytes / (1024 * 1024)).toFixed(1);
                        document.getElementById('statBytes').textContent = mb + ' MB';

                        // Codec
                        if (report.codecId) {
                            const codecReport = stats.get(report.codecId);
                            if (codecReport) {
                                document.getElementById('statCodec').textContent =
                                    codecReport.mimeType || '‚Äî';
                            }
                        }

                        // Resolution
                        if (report.frameWidth && report.frameHeight) {
                            document.getElementById('statRes').textContent =
                                report.frameWidth + '√ó' + report.frameHeight;
                        }
                    }

                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                        const rtt = report.currentRoundTripTime
                            ? (report.currentRoundTripTime * 1000).toFixed(0) + ' ms'
                            : '‚Äî';
                        document.getElementById('statRtt').textContent = rtt;
                        document.getElementById('overlayRtt').textContent = rtt;

                        // Get candidate details for connection info
                        const localId = report.localCandidateId;
                        const remoteId = report.remoteCandidateId;
                        if (localId) {
                            const local = stats.get(localId);
                            if (local) {
                                const addr = (local.address || local.ip || '?') + ':' + (local.port || '?');
                                document.getElementById('statLocalIp').textContent = addr;
                                const type = local.candidateType || '‚Äî';
                                const isRelay = type === 'relay';
                                document.getElementById('statConnType').textContent = isRelay
                                    ? 'üîÑ TURN Relay'
                                    : type === 'srflx' ? 'üåê STUN (NAT)'
                                        : type === 'host' ? 'üìç Direct'
                                            : type === 'prflx' ? 'üîÄ Peer Reflexive'
                                                : type;
                                document.getElementById('statProtocol').textContent =
                                    (local.protocol || '‚Äî').toUpperCase() +
                                    (local.relayProtocol ? ' ‚Üí ' + local.relayProtocol.toUpperCase() : '');
                            }
                        }
                        if (remoteId) {
                            const remote = stats.get(remoteId);
                            if (remote) {
                                const addr = (remote.address || remote.ip || '?') + ':' + (remote.port || '?');
                                document.getElementById('statRemoteIp').textContent = addr;
                            }
                        }
                    }
                });
            }, 1000);
        }

        function stopStatsMonitor() {
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
        }

        function disconnect() {
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
            cleanup();
            log('Disconnected by user', 'warn');
        }

        function cleanup() {
            stopStatsMonitor();

            if (pc) {
                pc.close();
                pc = null;
            }
            if (ws) {
                ws.onclose = null; // Prevent auto-reconnect
                ws.close();
                ws = null;
            }
            peerId = null;

            video.srcObject = null;
            setStatus('disconnected');

            // Reset stats display
            ['statState', 'statIce', 'statCodec', 'statRes', 'statFps', 'statBitrate',
                'statRtt', 'statLost', 'statJitter', 'statBytes',
                'statConnType', 'statRemoteIp', 'statLocalIp', 'statProtocol'].forEach(id => {
                    document.getElementById(id).textContent = '‚Äî';
                });
            ['overlayFps', 'overlayBitrate', 'overlayRtt'].forEach(id => {
                document.getElementById(id).textContent = '--';
            });
        }

        // Ping keepalive
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, 10000);
    </script>
</body>

</html>